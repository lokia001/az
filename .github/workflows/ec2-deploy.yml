name: Auto Deploy to EC2 on Push to Main

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ‚úÖ Checkout code
      uses: actions/checkout@v3

    # ----------- FRONTEND ----------
    - name: üîß Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '22'

    - name: üì¶ Install & Build Frontend
      run: |
        cd Frontend # << THAY ƒê·ªîI: ƒê∆∞·ªùng d·∫´n t·ªõi th∆∞ m·ª•c frontend c·ªßa b·∫°n (Frontendtest)
        npm install
        npm run build
        ls -la dist

    # ----------- BACKEND -----------
    - name: üîß Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.x'

    - name: üîß Install EF Core CLI Tools
      run: dotnet tool install --global dotnet-ef

    - name: üìã Prepare Database Migration Solution
      run: |
        cd src/Backend.Api # ƒê∆∞·ªùng d·∫´n t·ªõi Backend.Api c·ªßa b·∫°n
        echo "üîç Checking existing migrations..."
        dotnet ef migrations list
        
        echo "üìù Creating migration script for SQLite..."
        # T·∫°o script migration kh√¥ng idempotent (SQLite kh√¥ng h·ªó tr·ª£ idempotent)
        dotnet ef migrations script --output sql_migrations.sql || echo "No migrations needed or error occurred"
        
        if [ -f sql_migrations.sql ]; then
          echo "‚úÖ Migration script created successfully"
          # Th√™m transaction v√†o script ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nguy√™n v·∫πn
          sed -i '1i BEGIN TRANSACTION;' sql_migrations.sql
          echo "COMMIT;" >> sql_migrations.sql
          
          # Hi·ªÉn th·ªã preview script
          echo "üìã Preview of migration script:"
          cat sql_migrations.sql | head -n 20
          echo "..."
          wc -l sql_migrations.sql | awk '{print "Total lines in migration script:", $1}'
        else
          echo "‚ö†Ô∏è No migration script generated - no pending migrations or error occurred" 
          # T·∫°o file r·ªóng ƒë·ªÉ ti·∫øp t·ª•c workflow
          echo "-- No migrations to apply" > sql_migrations.sql
        fi

    - name: üì¶ Publish Backend
      run: dotnet publish -c Release -o publish
      working-directory: src/Backend.Api # << THAY ƒê·ªîI: ƒê∆∞·ªùng d·∫´n t·ªõi Backend.Api c·ªßa b·∫°n (src/Backend.Api)


 # ----------- PREPARE SERVER (Optional, if needed for first time or permissions) -----------
    - name: üì¶ Prepare Database Directory on EC2
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          DB_DIR="/var/app_data/my_backend_db" # ƒê∆∞·ªùng d·∫´n database gi·ªëng file c≈©
          APP_USER="${{ secrets.EC2_USER }}"

          echo "Ensuring database directory $DB_DIR exists..."
          sudo mkdir -p $DB_DIR
          echo "Setting ownership of $DB_DIR to $APP_USER..."
          sudo chown -R $APP_USER:$APP_USER $DB_DIR
          sudo chmod -R 700 $DB_DIR
          echo "Database directory prepared."


    # ----------- CLEAN REMOTE FOLDERS -----------
    - name: üßπ Clean remote frontend folder
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sudo rm -rf /var/www/html/*
          sudo mkdir -p /var/www/html
          sudo chown -R ${{ secrets.EC2_USER }}:${{ secrets.EC2_USER }} /var/www/html

    - name: üßπ Clean remote backend folder
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sudo rm -rf /home/${{ secrets.EC2_USER }}/app/backend/* # << THAY ƒê·ªîI: ƒê∆∞·ªùng d·∫´n backend tr√™n EC2
          sudo mkdir -p /home/${{ secrets.EC2_USER }}/app/backend
          sudo chown -R ${{ secrets.EC2_USER }}:${{ secrets.EC2_USER }} /home/${{ secrets.EC2_USER }}/app/backend

    # ---------- UPLOAD FRONTEND ----------
    - name: üì§ Upload Frontend to EC2 (~/webclient)
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "./Frontend/dist" # ƒê∆∞·ªùng d·∫´n m·ªõi t·ªõi th∆∞ m·ª•c dist c·ªßa frontend
        target: "/home/${{ secrets.EC2_USER }}/webclient/"
        debug: true

    - name: üöö Move Frontend to Nginx folder
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sudo rm -rf /var/www/html/*
          sudo mv /home/${{ secrets.EC2_USER }}/webclient/Frontend/dist/* /var/www/html/ # ƒê∆∞·ªùng d·∫´n m·ªõi dist
          sudo chown -R www-data:www-data /var/www/html
          sudo chmod -R 755 /var/www/html

    # ---------- UPLOAD NGINX CONFIG ----------
    # - name: üì§ Upload Nginx Configuration
    #   uses: appleboy/scp-action@v0.1.4
    #   with:
    #     host: ${{ secrets.EC2_IP }}
    #     username: ${{ secrets.EC2_USER }}
    #     key: ${{ secrets.SSH_PRIVATE_KEY }}
    #     source: "./nginx/working.conf"
    #     target: "/home/${{ secrets.EC2_USER }}/app/"
    #     overwrite: true

    # ---------- UPLOAD BACKEND ----------
    - name: üöÄ Upload Backend to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: src/Backend.Api/publish/ # ƒê∆∞·ªùng d·∫´n m·ªõi t·ªõi th∆∞ m·ª•c publish c·ªßa backend
        target: /home/${{ secrets.EC2_USER }}/app/backend/
        overwrite: true
        
    # T·∫°o file r·ªóng n·∫øu kh√¥ng t·ªìn t·∫°i ƒë·ªÉ tr√°nh l·ªói trong b∆∞·ªõc upload
    - name: üîç Ensure migration script exists
      run: |
        if [ ! -f "src/Backend.Api/sql_migrations.sql" ]; then
          echo "‚ö†Ô∏è Migration script not found, creating empty file"
          echo "-- No migrations to apply" > src/Backend.Api/sql_migrations.sql
        else
          echo "‚úÖ Migration script found"
          cat src/Backend.Api/sql_migrations.sql | head -n 5
        fi
        
    # Upload SQL migration script with verbose options
    - name: üì§ Upload SQL Migration Script
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: src/Backend.Api/sql_migrations.sql
        target: /home/${{ secrets.EC2_USER }}/app/
        overwrite: true
        debug: true
        strip_components: 2

    # Th√™m b∆∞·ªõc √°p d·ª•ng migration script
    - name: üîÑ Apply Database Migrations 
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "üìù Creating database backup before migrations..."
          BACKUP_FILE="/var/app_data/backup_$(date +%Y%m%d_%H%M%S).db"
          CONNECTION_STRING="${{ secrets.PROD_DB_CONNECTION_STRING }}"
          DB_PATH=$(echo $CONNECTION_STRING | sed -n 's/.*Data Source=\([^;]*\).*/\1/p')
          
          if [ -f "$DB_PATH" ]; then
            echo "Backing up database from $DB_PATH to $BACKUP_FILE"
            cp "$DB_PATH" "$BACKUP_FILE"
          else
            echo "‚ö†Ô∏è Warning: Database file not found at $DB_PATH, skipping backup"
          fi
          
          echo "üîÑ Applying database migrations..."
          # Kh·ªüi t·∫°o c√°c bi·∫øn m√¥i tr∆∞·ªùng c·∫ßn thi·∫øt
          export ConnectionStrings__DefaultConnection="${{ secrets.PROD_DB_CONNECTION_STRING }}"
          
          # Ki·ªÉm tra k·∫øt n·ªëi
          if [ -f "$DB_PATH" ]; then
            echo "‚úÖ Database file exists at $DB_PATH"
          else
            echo "‚ö†Ô∏è Database file not found, will be created by migration"
          fi
          
          # Ki·ªÉm tra xem file migration ƒë√£ ƒë∆∞·ª£c upload ch∆∞a
          echo "üìã Checking for migration script..."
          MIGRATION_FILE="/home/${{ secrets.EC2_USER }}/app/sql_migrations.sql"
          
          if [ ! -f "$MIGRATION_FILE" ]; then
            echo "‚ùå Migration script not found at $MIGRATION_FILE"
            echo "Listing directory content to debug:"
            ls -la /home/${{ secrets.EC2_USER }}/app/
            echo "Creating empty migration file..."
            echo "-- No migrations to apply" > $MIGRATION_FILE
          fi
          
          # √Åp d·ª•ng script SQL
          echo "üìã Applying SQL migration script..."
          cp $MIGRATION_FILE /tmp/migration.sql
          chmod 644 /tmp/migration.sql  # Ensure file is readable
          
          # Ki·ªÉm tra n·ªôi dung script tr∆∞·ªõc khi √°p d·ª•ng
          echo "Content of migration script:"
          cat /tmp/migration.sql | head -n 10
          MIGRATION_CONTENT=$(cat /tmp/migration.sql)
          if [[ "$MIGRATION_CONTENT" == *"No migrations to apply"* ]]; then
            echo "‚úÖ No migrations to apply, skipping..."
          else
            # C√†i ƒë·∫∑t sqlite3 n·∫øu ch∆∞a c√≥
            if ! command -v sqlite3 &> /dev/null; then
              echo "Installing sqlite3..."
              sudo apt-get update && sudo apt-get install -y sqlite3
            fi
            
            # S·ª≠ d·ª•ng SQLite CLI ƒë·ªÉ √°p d·ª•ng migrations
            SQLITE_DB=$DB_PATH
            echo "Running migrations on $SQLITE_DB"
            
            # Ch·∫°y script v√† ki·ªÉm tra l·ªói
            echo "Executing migration script..."
            if [ -s "/tmp/migration.sql" ]; then
              # Ki·ªÉm tra l·∫°i file c√≥ s·∫µn s√†ng kh√¥ng
              ls -la /tmp/migration.sql
              
              # Ch·∫°y t·ª´ng c√¢u l·ªánh SQL thay v√¨ d√πng input redirection
              echo ".read /tmp/migration.sql" | sqlite3 "$SQLITE_DB"
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ Database migration completed successfully!"
              else
                echo "‚ùå Migration failed with error code $?"
                echo "Migration script content:"
                cat /tmp/migration.sql
                echo "Rolling back to backup..."
                
                if [ -f "$BACKUP_FILE" ]; then
                  cp "$BACKUP_FILE" "$DB_PATH"
                  echo "‚úÖ Restored from backup: $BACKUP_FILE"
                else
                  echo "‚ö†Ô∏è No backup available for restore!"
                fi
                
                # Chuy·ªÉn qua ph∆∞∆°ng √°n thay th·∫ø thay v√¨ exit
                echo "Trying alternative approach..."
              fi
            else
              echo "‚ö†Ô∏è Migration script is empty or not readable"
              echo "Trying alternative approach..."
            fi
          fi
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Database migrations applied successfully!"
          else
            echo "‚ùå Failed to apply migrations using SQL script!"
            echo "Trying alternative approach with dotnet ef database update..."
            
            echo "Attempting to apply migrations directly with dotnet ef..."
            
            # Di chuy·ªÉn ƒë·∫øn th∆∞ m·ª•c backend
            cd /home/${{ secrets.EC2_USER }}/app/backend/publish
            
            # C√†i ƒë·∫∑t dotnet ef tools n·∫øu ch∆∞a c√≥
            if ! command -v dotnet-ef &> /dev/null; then
              echo "Installing dotnet-ef tools..."
              dotnet tool install --global dotnet-ef || true
              export PATH="$PATH:$HOME/.dotnet/tools"
            fi
            
            # C·∫•u h√¨nh m√¥i tr∆∞·ªùng
            export ConnectionStrings__DefaultConnection="${{ secrets.PROD_DB_CONNECTION_STRING }}"
            export ASPNETCORE_ENVIRONMENT="Production"
            
            # Ki·ªÉm tra migrations c√≥ s·∫µn
            echo "Listing available migrations:"
            dotnet ef migrations list || echo "Could not list migrations"
            
            # Ch·∫°y database update
            echo "Running database update..."
            if dotnet ef database update; then
              echo "‚úÖ Database migration completed successfully using dotnet ef database update!"
            else
              echo "‚ùå Migration failed with both approaches"
              
              if [ -f "$BACKUP_FILE" ]; then
                echo "Restoring from backup..."
                cp "$BACKUP_FILE" "$DB_PATH"
                echo "‚úÖ Restored from backup: $BACKUP_FILE"
                
                # Kh√¥ng exit, cho ph√©p ·ª©ng d·ª•ng ch·∫°y v·ªõi database c≈©
                echo "‚ö†Ô∏è Application will continue with the previous database version"
              else
                echo "‚ö†Ô∏è No backup available for restore! Application may not work correctly."
              fi
            fi
          fi

# ---------- SSH & RESTART ----------
    - name: ‚öôÔ∏è Configure Backend Environment and Restart Service
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "Updating systemd service environment variables for backend..."

          # ƒê·ªãnh nghƒ©a t√™n service v√† ƒë∆∞·ªùng d·∫´n ƒë·∫øn th∆∞ m·ª•c drop-in
          SERVICE_NAME="xyz-backend.service" # << THAY ƒê·ªîI: T√™n service c·ªßa b·∫°n
          OVERRIDE_DIR="/etc/systemd/system/${SERVICE_NAME}.d"
          OVERRIDE_FILE="$OVERRIDE_DIR/99-app-secrets.conf"

          # T·∫°o th∆∞ m·ª•c drop-in n·∫øu ch∆∞a t·ªìn t·∫°i
          sudo mkdir -p $OVERRIDE_DIR

          # T·∫°o ho·∫∑c ghi ƒë√® file drop-in v·ªõi c√°c bi·∫øn m√¥i tr∆∞·ªùng m·ªõi
          echo "[Service]" | sudo tee $OVERRIDE_FILE > /dev/null
          echo "Environment=\"ASPNETCORE_ENVIRONMENT=Production\"" | sudo tee -a $OVERRIDE_FILE > /dev/null
          
          # Database Connection
          echo "Environment=\"ConnectionStrings__DefaultConnection=${{ secrets.PROD_DB_CONNECTION_STRING }}\"" | sudo tee -a $OVERRIDE_FILE > /dev/null
          
          # JWT Configuration
          echo "Environment=\"Jwt__Key=${{ secrets.PROD_JWT_KEY }}\"" | sudo tee -a $OVERRIDE_FILE > /dev/null
          echo "Environment=\"Jwt__Issuer=${{ secrets.PROD_JWT_ISSUER }}\"" | sudo tee -a $OVERRIDE_FILE > /dev/null
          echo "Environment=\"Jwt__Audience=${{ secrets.PROD_JWT_AUDIENCE }}\"" | sudo tee -a $OVERRIDE_FILE > /dev/null
          
          # Storage & Email ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh
          
          # Cloudinary Configuration (Image Storage)
          echo "Environment=\"Cloudinary__CloudName=${{ secrets.CLOUDINARY_CLOUD_NAME }}\"" | sudo tee -a $OVERRIDE_FILE > /dev/null
          echo "Environment=\"Cloudinary__ApiKey=${{ secrets.CLOUDINARY_API_KEY }}\"" | sudo tee -a $OVERRIDE_FILE > /dev/null
          echo "Environment=\"Cloudinary__ApiSecret=${{ secrets.CLOUDINARY_API_SECRET }}\"" | sudo tee -a $OVERRIDE_FILE > /dev/null
          
          # DialogFlow Configuration
          echo "Environment=\"DialogFlow__ProjectId=${{ secrets.DIALOGFLOW_PROJECT_ID }}\"" | sudo tee -a $OVERRIDE_FILE > /dev/null
          echo "Environment=\"DialogFlow__JsonPath=${{ secrets.DIALOGFLOW_JSON_PATH }}\"" | sudo tee -a $OVERRIDE_FILE > /dev/null
          echo "Environment=\"GOOGLE_APPLICATION_CREDENTIALS=${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}\"" | sudo tee -a $OVERRIDE_FILE > /dev/null

          echo "Reloading systemd daemon and restarting service..."
          sudo systemctl daemon-reload
          sudo systemctl restart ${SERVICE_NAME}

          echo "Backing up existing Nginx configuration..."
          sudo mkdir -p /etc/nginx/sites-available/backup
          timestamp=$(date +%Y%m%d_%H%M%S)
          if [ -f /etc/nginx/sites-available/working.conf ]; then
            sudo cp /etc/nginx/sites-available/working.conf "/etc/nginx/sites-available/backup/working.conf.$timestamp"
          fi

          echo "Updating Nginx configuration..."
          # Copy new config
          sudo cp /home/${{ secrets.EC2_USER }}/app/nginx/working.conf /etc/nginx/sites-available/

          # Remove existing symlink if it exists
          sudo rm -f /etc/nginx/sites-enabled/working.conf
          
          # Create new symlink
          sudo ln -sf /etc/nginx/sites-available/working.conf /etc/nginx/sites-enabled/

          # Test nginx configuration
          echo "Testing Nginx configuration..."
          if sudo nginx -t; then
            echo "Nginx configuration test passed. Reloading Nginx..."
            sudo systemctl reload nginx
          else
            echo "Nginx configuration test failed. Rolling back to previous config..."
            if [ -f "/etc/nginx/sites-available/backup/working.conf.$timestamp" ]; then
              sudo cp "/etc/nginx/sites-available/backup/working.conf.$timestamp" /etc/nginx/sites-available/working.conf
              sudo systemctl reload nginx
            fi
            exit 1
          fi

          echo "Checking Nginx Configuration Status..."
          echo "----------------------------------------"
          echo "1. Current Nginx Sites Available:"
          ls -la /etc/nginx/sites-available/
          echo "----------------------------------------"
          echo "2. Current Nginx Sites Enabled:"
          ls -la /etc/nginx/sites-enabled/
          echo "----------------------------------------"
          echo "3. Nginx Service Status:"
          sudo systemctl status nginx --no-pager
          echo "----------------------------------------"
          echo "4. Checking Directory Contents and Permissions:"
          echo "Frontend files in /var/www/html/:"
          ls -la /var/www/html/
          echo "----------------------------------------"
          echo "Backend files in /home/${{ secrets.EC2_USER }}/app/backend/:"
          ls -la /home/${{ secrets.EC2_USER }}/app/backend/
          echo "----------------------------------------"
          
          echo "5. Nginx Configuration Test:"
          sudo nginx -t
          echo "----------------------------------------"
          
          echo "6. Current Nginx Configuration:"
          sudo nginx -T
          echo "----------------------------------------"
          
          echo "7. Checking Ports and Services:"
          echo "Nginx ports:"
          sudo netstat -tlpn | grep nginx
          echo "Backend service ports:"
          sudo netstat -tlpn | grep dotnet
          echo "----------------------------------------"
          
          echo "8. Checking Logs:"
          echo "Nginx error log:"
          sudo tail -n 50 /var/log/nginx/error.log
          echo "----------------------------------------"
          echo "Nginx access log:"
          sudo tail -n 50 /var/log/nginx/access.log
          echo "----------------------------------------"

          echo "‚úÖ Deployment done!"
          echo "ƒê·ªÉ x√°c minh bi·∫øn m√¥i tr∆∞·ªùng, SSH v√†o server v√† ch·∫°y: sudo systemctl show ${SERVICE_NAME} --property=Environment"

# ---------- VERIFY DEPLOYMENT & RESTART SERVICE ----------
    - name: üö® Verify Backend Deployment & Force Restart
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "============= BACKEND DEPLOYMENT VERIFICATION ============="
          SERVICE_NAME="xyz-backend.service" # << THAY ƒê·ªîI: T√™n service c·ªßa b·∫°n
          
          # Ki·ªÉm tra file Program.cs ƒë∆∞·ª£c deploy
          PROGRAM_CS="/home/${{ secrets.EC2_USER }}/app/backend/publish/Program.cs"
          if [ -f "$PROGRAM_CS" ]; then
            echo "‚úÖ Program.cs found in publish directory"
          else
            echo "‚ö†Ô∏è Program.cs not found in publish directory (normal for published app)"
          fi
          
          echo "Checking for PendingModelChanges handling code in published DLL"
          strings /home/${{ secrets.EC2_USER }}/app/backend/publish/Backend.Api.dll | grep -i "PendingModelChanges" || echo "String not found"
          strings /home/${{ secrets.EC2_USER }}/app/backend/publish/Backend.Api.dll | grep -i "application will continue" || echo "String not found"
          
          echo "Stopping and starting service to ensure clean state..."
          sudo systemctl stop ${SERVICE_NAME}
          echo "Service stopped. Waiting 5 seconds..."
          sleep 5
          
          echo "Starting service..."
          sudo systemctl start ${SERVICE_NAME}
          sleep 5
          
          echo "Checking service status..."
          sudo systemctl status ${SERVICE_NAME} --no-pager
          
          echo "Tailing application logs..."
          sudo journalctl -u ${SERVICE_NAME} -n 50 --no-pager
          
          echo "============= VERIFICATION COMPLETE ============="
